<!-- Add this where you want to display the [CONNECT WALLET] button -->
<div id="shopisui-root"></div>

<!-- Add this script to a "Custom liquid" Shopify section -->
<script>
(function()
{
    // === Your custom code ===

    const structType = "0x57191e5e5c41166b90a4b7811ad3ec7963708aa537a8438c1761a5d33e2155fd::kumo::Kumo";

    async function onWalletChange(walletEvent) {
        try {
            const { client, address } = walletEvent.detail;
            console.debug("[shopisui.onWalletChange] wallet address:", address);

            if (!address) { return; }

            const ownsNft = await checkNftOwnership({ structType, address });
            console.debug("[shopisui.onWalletChange] owns NFT:", ownsNft ? "yes" : "no");

            alert(`You are connected as ${address} and ${ownsNft ? "DO own" : "do NOT own"} a Kumo NFT`); // TODO remove

            const nftOwnerEvent = new CustomEvent('nft-ownership-check', {
                detail: { address, ownsNft }
            });
            window.dispatchEvent(nftOwnerEvent);

            /* To handle the event in your Shopify custom code:

            window.addEventListener('nft-ownership-check', (event) => {
                const buyButton = document.getElementById('custom-cart-btn');
                if (buyButton) {
                    if (event.detail.ownsNft) {
                        buyButton.classList.remove('hidden');
                    } else {
                        buyButton.classList.add('hidden');
                    }
                }
            });
            */
        }
        catch (error) {
            console.warn("[shopisui.onWalletChange] error checking NFT ownership:", error);
        }
    }

    async function checkNftOwnership({ structType, address })
    {
        const query = `
        query {
            sui {
                nfts(
                    where: {
                        collection: { slug: { _eq: "${structType}" } }
                        owner: { _eq: "${address}" }
                    },
                    limit: 1
                ) {
                    token_id
                }
            }
        }`;

        const response = await fetch("https://api.indexer.xyz/graphql", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-user": atob("dHJhZGVwb3J0Lnh5eg=="),
                "x-api-key": atob("dm1xVnU1ay5mZTAwZjZlMzEwM2JhNTFkODM1YjIzODJlNjgwOWEyYQ=="),
            },
            body: JSON.stringify({ query })
        });

        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }

        const result = await response.json();

        return result.data.sui.nfts.length > 0;
    }

    // === ShopiSui ===

    // Load ShopiSui CSS
    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = "https://shopisui.polymedia.app/assets/index-BRDBaH6M.css";
    document.head.appendChild(cssLink);

    // Load and initialize ShopiSui JS
    const script = document.createElement("script");
    script.src = "https://shopisui.polymedia.app/assets/index-Blai89VI.js";
    script.onload = function() {
        window.shopisuiInit();
        window.addEventListener("shopisui-wallet-change", onWalletChange);
    };
    document.body.appendChild(script);
})();
</script>
