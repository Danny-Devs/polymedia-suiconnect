<style>
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .popup {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        width: 90%;
        max-width: 500px;
    }

    .popup h2 {
        margin-bottom: 20px;
    }

    .popup h3 {
        color: rgb(35, 35, 35);
    }

    .popup button {
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: 600;
        background: #1E88E5;
        color: white;
    }

    .popup button:hover {
        background: #1976D2;
    }

    .popup button.disconnect {
        background: #DC3545;
    }

    .popup button.disconnect:hover {
        background: #C82333;
    }

    .access-options {
        display: flex;
        flex-direction: column;
        gap: 30px;
        align-items: center;
        margin: 20px 0;
    }

    .option-section {
        width: 100%;
        max-width: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        text-align: center;
    }

    .option-section h3 {
        margin-bottom: 5px;
    }

    .option-section p {
        margin: 0;
    }

    .password-section input[type="password"] {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 200px;
    }

    .error-message {
        color: #ff4444;
        margin: 0;
    }
</style>

<div id="login-popup" class="popup-overlay">
    <div class="popup">
        <h2>Access Required</h2>
        <p>Connect your wallet OR enter the access password to continue</p>

        <div class="access-options">
            <div class="option-section wallet-section">
                <h3>Option 1: Connect Wallet</h3>
                <p>Connect wallet to verify NFT ownership</p>
                <div id="suiconnect-root"></div>
                <p id="wallet-error" class="error-message hidden">No NFT found in connected wallet</p>
            </div>

            <div class="option-section password-section">
                <h3>Option 2: Enter Password</h3>
                <input type="password" id="access-password" placeholder="Enter access password">
                <button onclick="checkPassword()">SUBMIT</button>
                <p id="password-error" class="error-message hidden">Incorrect password</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", showPopup);
    function showPopup() {
        const popup = document.getElementById("login-popup");
        popup.style.display = "flex";
    }

    window.addEventListener("suiconnect-wallet-change", onWalletChange);
    async function onWalletChange(walletEvent)
    {
        const structType = "0x57191e5e5c41166b90a4b7811ad3ec7963708aa537a8438c1761a5d33e2155fd::kumo::Kumo";
        try {
            const { address } = walletEvent.detail;
            if (!address) { return; }

            const ownsNft = await checkNftOwnership({ structType, address });
            console.debug("[suiconnect.onWalletChange] owns NFT:", ownsNft ? "yes" : "no");

            if (ownsNft) {
                hidePopupAndShowBuyButton();
            } else {
                const walletError = document.getElementById("wallet-error");
                walletError.classList.remove("hidden");
            }
        }
        catch (error) {
            console.warn("[suiconnect.onWalletChange] error checking NFT ownership:", error);
        }
    }

    function checkPassword() {
        const password = document.getElementById("access-password").value;
        const passwordError = document.getElementById("password-error");

        if (password === atob("a3Vtbw==") ) { // TODO
            hidePopupAndShowBuyButton();
        } else {
            passwordError.textContent = "Incorrect password";
            passwordError.classList.remove("hidden");
        }
    }

    function hidePopupAndShowBuyButton() {
        const popup = document.getElementById("login-popup");
        const buyButton = document.getElementById("custom-cart-btn");
        popup.classList.add("hidden");
        buyButton.classList.remove("hidden");
    }

    async function checkNftOwnership({ structType, address })
    {
        const query = `
        query {
            sui {
                nfts(
                    where: {
                        collection: { slug: { _eq: "${structType}" } }
                        owner: { _eq: "${address}" }
                    },
                    limit: 1
                ) {
                    token_id
                }
            }
        }`;

        const response = await fetch("https://api.indexer.xyz/graphql", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-user": atob("dHJhZGVwb3J0Lnh5eg=="),
                "x-api-key": atob("dm1xVnU1ay5mZTAwZjZlMzEwM2JhNTFkODM1YjIzODJlNjgwOWEyYQ=="),
            },
            body: JSON.stringify({ query })
        });

        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }

        const result = await response.json();

        return result.data.sui.nfts.length > 0;
    }
</script>
